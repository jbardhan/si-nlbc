boxlength = 29.9469998677572;
ksi = 2.837;
CONV = 332.112;
forwardPosQ = [ 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 0.2 0.22 0.24 0.26 0.28 0.3 0.32 0.34 0.36 0.38 0.4 0.42 0.44 0.46 0.48 0.5 0.52 0.54 0.56 0.58 0.6 0.62 0.64 0.66 0.68 0.7 0.72 0.74 0.76 0.78 0.8 0.82 0.84 0.86 0.88 0.9 0.92 0.94 0.96 0.98 1 ]';
forwardPosTotals = [ 0.145852 0.258143 0.336788 0.325507 0.29662 0.181055 0.0472346 -0.14581 -0.373095 -0.66813 -0.994171 -1.3861 -1.83435 -2.32312 -2.87551 -3.48583 -4.13384 -4.86808 -5.65584 -6.43398 -7.30562 -8.19771 -9.18652 -10.2441 -11.3041 -12.4464 -13.608 -14.8547 -16.1578 -17.5576 -18.9929 -20.4785 -22.0011 -23.5595 -25.2258 -26.9482 -28.7412 -30.5899 -32.4677 -34.3921 -36.4452 -38.5607 -40.7007 -42.9388 -45.2152 -47.567 -49.9225 -52.424 -54.973 -57.5344 ]';
reversedBackwardPosTotals = [ 0.153776 0.2361515 0.3009894 0.30837562 0.24980822 0.16278452 0.00326152000000005 -0.19031848 -0.44768548 -0.73431048 -1.09174548 -1.46409548 -1.88726248 -2.36441148 -2.90105148 -3.50882548 -4.18265048 -4.86718148 -5.61039648 -6.40032948 -7.27591048 -8.18991748 -9.14705948 -10.16708948 -11.26295948 -12.40592948 -13.60659948 -14.82375948 -16.12211948 -17.51285948 -18.99040948 -20.45859948 -22.00527948 -23.60900948 -25.29552948 -27.03701948 -28.82173948 -30.70521948 -32.60694948 -34.60304948 -36.63421948 -38.68891948 -40.84879948 -43.05241948 -45.31076948 -47.68534948 -50.09488948 -52.55619948 -55.11610948 -57.67157948 ]';
correctedFPtotals = forwardPosTotals - 0.5*ksi*CONV*forwardPosQ.^2 / boxlength;
correctedBPtotals = reversedBackwardPosTotals - 0.5*ksi*CONV*forwardPosQ.^2 / boxlength;
forwardNegQ = [ -0.02 -0.04 -0.06 -0.08 -0.1 -0.12 -0.14 -0.16 -0.18 -0.2 -0.22 -0.24 -0.26 -0.28 -0.3 -0.32 -0.34 -0.36 -0.38 -0.4 -0.42 -0.44 -0.46 -0.48 -0.5 -0.52 -0.54 -0.56 -0.58 -0.6 -0.62 -0.64 -0.66 -0.68 -0.7 -0.72 -0.74 -0.76 -0.78 -0.8 -0.82 -0.84 -0.86 -0.88 -0.9 -0.92 -0.94 -0.96 -0.98 -1 ]';
forwardNegTotals = [ -0.197201 -0.463533 -0.79897 -1.18703 -1.62993 -2.17376 -2.71114 -3.3702 -4.11121 -4.90867 -5.74692 -6.69154 -7.73641 -8.86197 -10.0594 -11.3638 -12.7697 -14.2862 -15.8746 -17.5334 -19.3138 -21.1931 -23.1262 -25.1454 -27.3593 -29.6511 -32.0045 -34.4914 -37.0182 -39.7103 -42.4752 -45.3907 -48.3612 -51.3935 -54.5766 -57.7729 -61.1193 -64.6311 -68.1448 -71.7531 -75.4917 -79.3394 -83.2175 -87.1441 -91.2216 -95.3501 -99.5079 -103.703 -108.03 -112.466 ]';
reversedBackwardNegTotals = [ -0.227202 -0.534321 -0.858598 -1.267732 -1.704341 -2.195212 -2.792493 -3.436883 -4.194344 -5.005321 -5.87613 -6.870605 -7.964985 -9.104265 -10.341305 -11.587485 -12.967335 -14.444525 -16.036905 -17.768565 -19.527045 -21.428205 -23.397885 -25.496415 -27.675885 -29.962495 -32.332455 -34.845835 -37.402675 -40.139315 -42.846355 -45.692465 -48.616835 -51.667365 -54.832745 -58.024325 -61.395615 -64.806515 -68.417355 -72.028265 -75.769645 -79.534445 -83.401195 -87.311235 -91.311725 -95.430495 -99.602985 -103.816085 -108.207305 -112.658355 ]';
correctedFNtotals = forwardNegTotals - 0.5*ksi*CONV*forwardNegQ.^2 / boxlength;
correctedBNtotals = reversedBackwardNegTotals - 0.5*ksi*CONV*forwardNegQ.^2 / boxlength;
Qdata = [0; forwardPosQ; forwardPosQ; forwardNegQ; forwardNegQ;]; 
Edata = [0; correctedFPtotals; correctedBPtotals; correctedFNtotals; correctedBNtotals;];

I = find(abs(Qdata) < 0.2);
lsmatConstrained = [Qdata(I).^2 Qdata(I)];
lsmatUnconstrained = [Qdata(I).^2 Qdata(I) ones(length(Qdata(I)),1)];
xConstrained = lsmatConstrained \ Edata(I);
xUnconstrained = lsmatUnconstrained \ Edata(I);
L_constrained = xConstrained(1);
L_unconstrained = xUnconstrained(1);
phiStatic_constrained = xConstrained(2);
phiStatic_unconstrained = xUnconstrained(2);
offset_unconstrained = xUnconstrained(3);
