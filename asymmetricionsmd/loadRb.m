boxlength = 29.9469998677572;
ksi = 2.837;
CONV = 332.112;
forwardPosQ = [ 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 0.2 0.22 0.24 0.26 0.28 0.3 0.32 0.34 0.36 0.38 0.4 0.42 0.44 0.46 0.48 0.5 0.52 0.54 0.56 0.58 0.6 0.62 0.64 0.66 0.68 0.7 0.72 0.74 0.76 0.78 0.8 0.82 0.84 0.86 0.88 0.9 0.92 0.94 0.96 0.98 1 ]';
forwardPosTotals = [ 0.12186 0.236259 0.271464 0.285133 0.264774 0.213229 0.101259 -0.0422373 -0.266934 -0.532031 -0.834766 -1.19747 -1.59312 -2.05885 -2.56978 -3.08724 -3.67851 -4.27589 -4.9321 -5.63262 -6.3883 -7.18747 -8.03277 -8.96721 -9.91867 -10.9148 -11.9764 -13.0762 -14.2286 -15.4123 -16.6841 -17.9375 -19.2879 -20.7421 -22.2281 -23.7706 -25.3697 -27.0073 -28.7582 -30.5083 -32.2782 -34.078 -36.0123 -37.9968 -40.0458 -42.134 -44.2688 -46.4911 -48.7646 -51.0503 ]';
reversedBackwardPosTotals = [ 0.185977 0.2824646 0.3318892 0.33563378 0.29927398 0.22942538 0.10788238 -0.05951562 -0.27648662 -0.51592862 -0.82542762 -1.18731462 -1.59095962 -2.04839762 -2.50209362 -3.00591162 -3.56276462 -4.16419162 -4.81986462 -5.55731062 -6.31643162 -7.11660862 -7.99101362 -8.91342862 -9.85937562 -10.84270962 -11.89294962 -13.02205962 -14.19052962 -15.40727962 -16.65927962 -17.97251962 -19.35732962 -20.75325962 -22.20385962 -23.71402962 -25.32181962 -26.97396962 -28.63619962 -30.37254962 -32.16401962 -34.04853962 -35.98225962 -37.96054962 -39.93773962 -42.02276962 -44.18421962 -46.36967962 -48.67165962 -50.96828962 ]';
correctedFPtotals = forwardPosTotals - 0.5*ksi*CONV*forwardPosQ.^2 / boxlength;
correctedBPtotals = reversedBackwardPosTotals - 0.5*ksi*CONV*forwardPosQ.^2 / boxlength;
forwardNegQ = [ -0.02 -0.04 -0.06 -0.08 -0.1 -0.12 -0.14 -0.16 -0.18 -0.2 -0.22 -0.24 -0.26 -0.28 -0.3 -0.32 -0.34 -0.36 -0.38 -0.4 -0.42 -0.44 -0.46 -0.48 -0.5 -0.52 -0.54 -0.56 -0.58 -0.6 -0.62 -0.64 -0.66 -0.68 -0.7 -0.72 -0.74 -0.76 -0.78 -0.8 -0.82 -0.84 -0.86 -0.88 -0.9 -0.92 -0.94 -0.96 -0.98 -1 ]';
forwardNegTotals = [ -0.19235 -0.429614 -0.745746 -1.11554 -1.52946 -1.99777 -2.55367 -3.14042 -3.81216 -4.5666 -5.33523 -6.17993 -7.13588 -8.13138 -9.23263 -10.3851 -11.5966 -12.9445 -14.3414 -15.8354 -17.4348 -18.9951 -20.7246 -22.5302 -24.3685 -26.4004 -28.4507 -30.5198 -32.7296 -34.9667 -37.4111 -39.9122 -42.5146 -45.1437 -47.8794 -50.6923 -53.6315 -56.575 -59.6394 -62.7482 -66.0062 -69.2829 -72.6722 -76.067 -79.5719 -83.1981 -86.9116 -90.652 -94.429 -98.3354 ]';
reversedBackwardNegTotals = [ -0.208714 -0.45567 -0.780619 -1.115403 -1.514328 -1.989187 -2.498532 -3.060131 -3.70238 -4.497893 -5.297682 -6.120632 -7.060358 -8.093308 -9.197768 -10.386118 -11.576678 -12.870128 -14.323108 -15.798198 -17.342788 -19.014588 -20.729558 -22.517868 -24.386438 -26.317438 -28.392528 -30.532258 -32.817288 -35.163368 -37.554768 -39.954218 -42.503468 -45.236308 -48.008918 -50.851118 -53.738278 -56.778628 -59.867108 -63.060478 -66.352068 -69.650008 -73.091498 -76.546328 -80.092438 -83.747248 -87.484448 -91.242218 -95.108238 -99.060888 ]';
correctedFNtotals = forwardNegTotals - 0.5*ksi*CONV*forwardNegQ.^2 / boxlength;
correctedBNtotals = reversedBackwardNegTotals - 0.5*ksi*CONV*forwardNegQ.^2 / boxlength;
Qdata = [0; forwardPosQ; forwardPosQ; forwardNegQ; forwardNegQ;]; 
Edata = [0; correctedFPtotals; correctedBPtotals; correctedFNtotals; correctedBNtotals;];

I = find(abs(Qdata) < 0.2);
lsmatConstrained = [Qdata(I).^2 Qdata(I)];
lsmatUnconstrained = [Qdata(I).^2 Qdata(I) ones(length(Qdata(I)),1)];
xConstrained = lsmatConstrained \ Edata(I);
xUnconstrained = lsmatUnconstrained \ Edata(I);
L_constrained = xConstrained(1);
L_unconstrained = xUnconstrained(1);
phiStatic_constrained = xConstrained(2);
phiStatic_unconstrained = xUnconstrained(2);
offset_unconstrained = xUnconstrained(3);
